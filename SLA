WITH slg AS (
	SELECT stowcartid
		, skuid
		, createdat AS sdt
		, CASE
			WHEN HOUR(createdat) < 7 THEN HOUR(createdat) + 24
			ELSE HOUR(createdat)
	  	  END AS STOW_HOUR
	  	, quantity as stow_unit
	FROM ods.stow_logs
	WHERE CASE
			WHEN HOUR(now()) > 7 THEN createdat >= DATE_TRUNC('day', now()) + INTERVAL '7' HOUR
 			ELSE createdat >= DATE_TRUNC('day', now() - INTERVAL '1' DAY) + INTERVAL '7' HOUR
		 END
),
lot AS (
	SELECT id
	FROM ods.lots
	WHERE centerid = 151
),
rsw AS (
	SELECT skuid
		, unloadworkid
		, receivestationplacementid AS rspid
		, SUM(quantity) AS quantity
	FROM ods.receive_station_work_logs
	GROUP BY 1, 2, 3
),
rsp AS (
	SELECT id
		, TYPE
		, receivefilterid AS rft
		, updatedat AS rdt
		, stowcartid
	FROM ods.receive_station_placement
	WHERE centercode = 'KKW3'
	  AND stowcartid IS NOT NULL
),
rft AS (
	SELECT id
		, name
	FROM ods.wib_receive_filters
	WHERE centercode = 'KKW3'
),
rcv AS (
	SELECT rdt
		, rsw.unloadworkid AS ibc
		, rsp.stowcartid
		, rft.name AS rcvfilter
		, rsw.skuid
		, rsp.TYPE AS worktype
		, SUM(rsw.quantity) AS rcv_unit
	FROM rsw
		INNER JOIN rsp ON rsp.id = rsw.rspid
		LEFT JOIN rft ON rft.id = rsp.rft
	WHERE rsw.quantity > 0
	GROUP BY 1, 2, 3, 4, 5, 6
),
ulw AS (
	SELECT id AS ibc
		, createdat AS udt
	FROM ods.unload_works
	WHERE centerid = 151
),
fin AS (
	SELECT CASE
			WHEN worktype = 'RETURN_RECEIVING' THEN 'RETURN'
			WHEN worktype = 'TRANSFER_RECEIVING' THEN 'RC'
			WHEN rcvfilter LIKE '%ATS%' THEN 'ATS'
			WHEN rcvfilter LIKE '%RG%' THEN 'RG'
			ELSE 'Retail'
		  END AS rcv_filter_flag
		  , stow_hour
		  , stow_unit
		  , DATE_DIFF('second', COALESCE(udt, rdt), rdt) / 3600.00 AS U2R
		  , DATE_DIFF('second', rdt, sdt) / 3600.00 AS R2S
		  , DATE_DIFF('second', COALESCE(udt, rdt), sdt) / 3600.00 AS U2S
	FROM slg
		INNER JOIN rcv ON rcv.stowcartid = slg.stowcartid
					AND rcv.skuid = slg.skuid
		INNER JOIN ulw ON ulw.ibc = rcv.ibc
)
SELECT stow_hour, rcv_filter_flag
	, SUM(stow_unit) AS total_stow_unit
	, round(approx_percentile(U2R, 0.99), 1) AS U2R_P99
	, round(approx_percentile(R2S, 0.99), 1) AS R2S_P99
	, round(approx_percentile(U2S, 0.99), 1) AS U2S_P99
FROM fin
GROUP BY 1, 2
ORDER BY 1, 2
